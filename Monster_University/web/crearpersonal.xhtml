<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="/template.xhtml">
    
    <ui:define name="title">Crear Nueva Persona</ui:define>

    <ui:define name="body">
        <div class="form-container" style="max-width: 800px; margin: 0 auto; padding: 20px; background-color: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 1;">
            
            <script>
                function debug(message) {
                    console.log("[DEBUG] " + message);
                }
                
                function debugError(message) {
                    console.error("[ERROR] " + message);
                }
                
                function debugSuccess(message) {
                    console.log("‚úÖ " + message);
                }
                
                console.log("=== FORMULARIO CREAR PERSONA CARGADO ===");
                
                document.addEventListener('DOMContentLoaded', function() {
                    console.log("üìù INSTRUCCIONES:");
                    console.log("1. Llena el formulario");
                    console.log("2. Los campos con * son obligatorios");
                    console.log("3. Estado Civil, Sexo y Celular son opcionales");
                    console.log("4. Haz click en 'Crear Persona'");
                });
            </script>
            
            <style>
                .form-header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #2a64c5;
                    padding-bottom: 10px;
                }
                
                .form-header h1 {
                    color: #2a64c5;
                    font-size: 2rem;
                    margin-bottom: 5px;
                }
                
                .form-header p {
                    color: #666;
                    font-size: 1rem;
                }
                
                .form-group {
                    margin-bottom: 20px;
                    padding: 10px;
                    border-radius: 5px;
                    background-color: #f8f9fa;
                }
                
                .form-label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: bold;
                    color: #495057;
                    font-size: 0.9rem;
                }
                
                .form-required {
                    color: #dc3545;
                    margin-left: 3px;
                }
                
                .form-actions {
                    margin-top: 30px;
                    text-align: center;
                    padding-top: 20px;
                    border-top: 1px solid #dee2e6;
                }
                
                .form-help {
                    margin-top: 15px;
                    padding: 10px;
                    background-color: #e7f3ff;
                    border-left: 4px solid #2a64c5;
                    font-size: 0.9rem;
                    color: #666;
                }
                
                .form-row {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .form-column {
                    flex: 1;
                }
                
                .field-hint {
                    font-size: 0.8rem;
                    color: #666;
                    margin-top: 5px;
                    font-style: italic;
                }
                
                .radio-group {
                    display: flex;
                    gap: 20px;
                    margin-top: 5px;
                    flex-wrap: wrap;
                }
                
                .radio-option {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .radio-label {
                    font-weight: normal;
                    color: #495057;
                    font-size: 0.9rem;
                }
                
                .tab-container {
                    margin-top: 20px;
                    border: 1px solid #dee2e6;
                    border-radius: 5px;
                    overflow: hidden;
                }
                
                .tab-buttons {
                    display: flex;
                    background-color: #f8f9fa;
                    border-bottom: 1px solid #dee2e6;
                }
                
                .tab-button {
                    padding: 12px 20px;
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 0.95rem;
                    font-weight: 500;
                    color: #495057;
                    transition: all 0.3s;
                    border-bottom: 3px solid transparent;
                }
                
                .tab-button:hover {
                    background-color: #e9ecef;
                }
                
                .tab-button.active {
                    color: #2a64c5;
                    border-bottom: 3px solid #2a64c5;
                    background-color: #e7f3ff;
                }
                
                .tab-content {
                    padding: 20px;
                    background-color: white;
                }
                
                .tab-pane {
                    display: none;
                }
                
                .tab-pane.active {
                    display: block;
                }
                
                .basic-info-section {
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                }
                
                .basic-info-row {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .basic-info-column {
                    flex: 1;
                }
            </style>
            
            <div class="form-header">
                <h1>üë§ Crear Nueva Persona</h1>
                <p>Complete los datos para registrar una nueva persona en el sistema</p>
            </div>
            
            <h:form id="formCrearPersona" enctype="multipart/form-data">
                
                <!-- C√≥digo generado -->
                <div class="form-group">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #495057;">
                        C√≥digo Persona: <span class="form-required">*</span>
                    </label>
                    <h:outputText value="#{crearPersonaController.codigoGenerado}" 
                                style="font-weight: bold; color: green; font-size: 1.2rem; display: block; padding: 8px; background-color: #e9ecef; border-radius: 4px;"/>
                    <div class="field-hint">(Generado autom√°ticamente)</div>
                </div>
                
                <!-- Secci√≥n de informaci√≥n b√°sica -->
                <div class="basic-info-section">
                    <h3 style="color: #2a64c5; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">
                        üìù Informaci√≥n B√°sica
                    </h3>
                    
                    <div class="basic-info-row">
                        <!-- Nombre -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="nombres" value="Nombres" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:inputText id="nombres" value="#{crearPersonaController.nuevaPersona.nombres}" 
                                           maxlength="50" style="width: 100%;"
                                           placeholder="Ingrese los nombres"
                                           required="true"
                                           requiredMessage="Los nombres son requeridos"/>
                                <div class="field-hint">(M√°ximo 50 caracteres)</div>
                                <p:message for="nombres" display="icon"/>
                            </div>
                        </div>
                        
                        <!-- Apellido -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="apellidos" value="Apellidos" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:inputText id="apellidos" value="#{crearPersonaController.nuevaPersona.apellidos}" 
                                           maxlength="50" style="width: 100%;"
                                           placeholder="Ingrese los apellidos"
                                           required="true"
                                           requiredMessage="Los apellidos son requeridos"/>
                                <div class="field-hint">(M√°ximo 50 caracteres)</div>
                                <p:message for="apellidos" display="icon"/>
                            </div>
                        </div>
                    </div>

                    <div class="basic-info-row">
                        <!-- Documento -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="documento" value="Documento" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:inputText id="documento" value="#{crearPersonaController.nuevaPersona.documento}" 
                                           maxlength="15" style="width: 100%;"
                                           placeholder="Ej: 1234567890"
                                           required="true"
                                           requiredMessage="El documento es requerido"/>
                                <div class="field-hint">(M√°ximo 15 caracteres)</div>
                                <p:message for="documento" display="icon"/>
                            </div>
                        </div>
                        
                        <!-- Fecha de Nacimiento -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="fecha_nacimiento" value="Fecha de Nacimiento" styleClass="form-label"/>
                                <p:calendar id="fecha_nacimiento" value="#{crearPersonaController.nuevaPersona.fecha_nacimiento}" 
                                            style="width: 100%;"
                                            pattern="dd/MM/yyyy" 
                                            locale="es" 
                                            showOn="button"
                                            placeholder="Seleccione fecha"
                                            yearRange="c-100:c"
                                            required="false">
                                    <f:convertDateTime pattern="dd/MM/yyyy" />
                                </p:calendar>
                                <div class="field-hint">(Opcional)</div>
                                <p:message for="fecha_nacimiento" display="icon"/>
                            </div>
                        </div>
                    </div>
                    
                    <div class="basic-info-row">
                        <!-- Celular -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="celular" value="Celular" styleClass="form-label"/>
                                <p:inputText id="celular" value="#{crearPersonaController.nuevaPersona.celular}" 
                                           maxlength="15" style="width: 100%;"
                                           placeholder="Ej: 0991234567 (opcional)"/>
                                <div class="field-hint">(Opcional, formato: 09XXXXXXXX)</div>
                                <p:message for="celular" display="icon"/>
                            </div>
                        </div>
                        
                        <!-- Fecha de Ingreso -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="fecha_ingreso" value="Fecha de Ingreso" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:calendar id="fecha_ingreso" value="#{crearPersonaController.nuevaPersona.fecha_ingreso}" 
                                            style="width: 100%;"
                                            pattern="dd/MM/yyyy" 
                                            locale="es" 
                                            showOn="button"
                                            placeholder="Seleccione fecha"
                                            required="true"
                                            requiredMessage="La fecha de ingreso es requerida">
                                    <f:convertDateTime pattern="dd/MM/yyyy" />
                                </p:calendar>
                                <p:message for="fecha_ingreso" display="icon"/>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n de pesta√±as -->
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" onclick="showTab('datosPersonales')">
                            üìã Datos Personales
                        </button>
                        <button type="button" class="tab-button" onclick="showTab('contactos')">
                            üìß Contactos
                        </button>
                    </div>
                    
                    <!-- Pesta√±a Datos Personales -->
                    <div class="tab-content">
                        <div id="datosPersonales" class="tab-pane active">
                            <div style="padding: 15px;">
                                <!-- Tipo de Persona -->
                                <div class="form-group">
                                    <h:outputLabel for="peperTipo" value="Tipo de Persona" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:selectOneMenu id="peperTipo" value="#{crearPersonaController.nuevaPersona.peperTipo}" 
                                                   style="width: 100%;"
                                                   required="true"
                                                   requiredMessage="Debe seleccionar un tipo">
                                        <f:selectItem itemLabel="Seleccione tipo" itemValue=""/>
                                        <f:selectItem itemLabel="Administrador del Sistema" itemValue="Administrador del Sistema"/>
                                        <f:selectItem itemLabel="Docente" itemValue="Docente"/>
                                        <f:selectItem itemLabel="Administrador de matr√≠culas" itemValue="Administrador de matriculas"/>
                                        <f:selectItem itemLabel="Secretar√≠a Acad√©mica" itemValue="Secretaria Academica"/>
                                    </p:selectOneMenu>
                                    <p:message for="peperTipo" display="icon"/>
                                </div>
                                
                                <!-- Sexo con Radio Button -->
                                <div class="form-group">
                                    <h:outputLabel for="sexoSeleccionado" value="Sexo" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:selectOneRadio id="sexoSeleccionado" 
                                                    value="#{crearPersonaController.sexoSeleccionado}"
                                                    layout="custom"
                                                    required="true"
                                                    requiredMessage="Debe seleccionar el sexo">
                                        <f:selectItem itemLabel="Masculino" itemValue="M"/>
                                        <f:selectItem itemLabel="Femenino" itemValue="F"/>
                                    </p:selectOneRadio>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <p:radioButton id="sexoM" for="sexoSeleccionado" itemIndex="0"/>
                                            <h:outputLabel for="sexoM" value="Masculino" styleClass="radio-label"/>
                                        </div>
                                        <div class="radio-option">
                                            <p:radioButton id="sexoF" for="sexoSeleccionado" itemIndex="1"/>
                                            <h:outputLabel for="sexoF" value="Femenino" styleClass="radio-label"/>
                                        </div>
                                    </div>
                                    <p:message for="sexoSeleccionado" display="icon"/>
                                </div>
                                
                                <!-- Estado Civil -->
                                <div class="form-group">
                                    <h:outputLabel for="estadoCivilSeleccionado" value="Estado Civil" styleClass="form-label"/>
                                    <p:selectOneMenu id="estadoCivilSeleccionado" 
                                                   value="#{crearPersonaController.estadoCivilSeleccionado}"
                                                   style="width: 100%;">
                                        <f:selectItem itemLabel="Seleccione estado civil" itemValue=""/>
                                        <f:selectItems value="#{crearPersonaController.opcionesEstadoCivilDesdeBD}" 
                                                     var="estadoCivil"
                                                     itemLabel="#{estadoCivil.nombre}" 
                                                     itemValue="#{estadoCivil.codigo}"/>
                                    </p:selectOneMenu>
                                    <div class="field-hint">(Opcional)</div>
                                    <p:message for="estadoCivilSeleccionado" display="icon"/>
                                </div>
                                
                                <!-- Imagen de perfil -->
                                <div class="form-group">
                                    <h:outputLabel for="imagenPersona" value="Imagen de Perfil" styleClass="form-label"/>
                                    
                                    <!-- FileUpload SIMPLE sin auto-upload -->
                                    <p:fileUpload id="imagenPersona" 
                                                  value="#{crearPersonaController.imagenSubida}"
                                                  mode="simple"
                                                  skinSimple="true"
                                                  sizeLimit="1048576"
                                                  allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
                                                  style="width: 100%; margin-bottom: 10px;"
                                                  required="false"/>
                                    
                                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                                        <!-- Bot√≥n Subir Imagen - AJAX simple -->
                                        <p:commandButton value="Subir Imagen"
                                                         action="#{crearPersonaController.subirImagen}"
                                                         ajax="true"
                                                         process="@form"
                                                         update=":formCrearPersona:vistaPreviaImagen 
                                                                 :formCrearPersona:mensajeImagen
                                                                 :formCrearPersona:infoImagen"
                                                         oncomplete="if(args &amp;&amp; !args.validationFailed) {PF('imagenWidget').clear();}"
                                                         icon="pi pi-upload"
                                                         styleClass="ui-button-success"/>
                                        
                                        <!-- Bot√≥n Eliminar Imagen -->
                                        <p:commandButton value="Eliminar Imagen"
                                                         action="#{crearPersonaController.eliminarImagen}"
                                                         ajax="true"
                                                         process="@this"
                                                         update=":formCrearPersona:vistaPreviaImagen 
                                                                 :formCrearPersona:mensajeImagen
                                                                 :formCrearPersona:infoImagen"
                                                         icon="pi pi-trash"
                                                         styleClass="ui-button-danger"
                                                         rendered="#{not empty crearPersonaController.nuevaPersona.imagen_perfil}"/>
                                    </div>
                                    
                                    <div class="field-hint">(Opcional, m√°ximo 1MB, formatos: JPG, PNG, GIF)</div>
                                    <p:message for="imagenPersona" id="mensajeImagen" />
                                    
                                    <!-- Informaci√≥n de la imagen subida -->
                                    <h:panelGroup id="infoImagen">
                                        <div style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
                                            <h:outputText value="üìÅ Archivo: #{crearPersonaController.nuevaPersona.imagen_perfil}"
                                                          rendered="#{not empty crearPersonaController.nuevaPersona.imagen_perfil}"
                                                          style="font-weight: bold;"/>
                                        </div>
                                    </h:panelGroup>
                                    
                                    <!-- Vista previa de imagen -->
                                    <h:panelGroup id="vistaPreviaImagen">
                                        <div style="margin-top: 15px; text-align: center;">
                                            <p:graphicImage value="#{crearPersonaController.urlImagen}"
                                                            rendered="#{not empty crearPersonaController.nuevaPersona.imagen_perfil}"
                                                            cache="false"
                                                            width="150"
                                                            height="150"
                                                            style="border-radius: 8px; border: 2px solid #ddd;
                                                                   object-fit: cover; max-width: 150px; max-height: 150px;
                                                                   box-shadow: 0 2px 5px rgba(0,0,0,0.1);"/>
                                        </div>
                                    </h:panelGroup>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Pesta√±a Contactos -->
                        <div id="contactos" class="tab-pane">
                            <div style="padding: 15px;">
                                <!-- Email -->
                                <div class="form-group">
                                    <h:outputLabel for="email" value="Email" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:inputText id="email" value="#{crearPersonaController.nuevaPersona.email}" 
                                                 maxlength="30" style="width: 100%;"
                                                 placeholder="ejemplo@correo.com"
                                                 required="true"
                                                 requiredMessage="El email es requerido">
                                        <f:validateRegex pattern="^[A-Za-z0-9+_.-]+@(.+)$" />
                                    </p:inputText>
                                    <div class="field-hint">(M√°ximo 30 caracteres)</div>
                                    <p:message for="email" display="icon"/>
                                </div>
                                
                                <!-- Estado (oculto, se asigna autom√°ticamente) -->
                                <h:inputHidden value="#{crearPersonaController.nuevaPersona.estado}"/>
                                
                                <!-- Username (oculto, se genera autom√°ticamente) -->
                                <h:inputHidden value="#{crearPersonaController.nuevaPersona.username}"/>
                                
                                <!-- Password hash (oculto, se genera autom√°ticamente) -->
                                <h:inputHidden value="#{crearPersonaController.nuevaPersona.password_hash}"/>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Script para manejar las pesta√±as -->
                <script>
                    function showTab(tabName) {
                        // Ocultar todas las pesta√±as
                        document.querySelectorAll('.tab-pane').forEach(function(tab) {
                            tab.classList.remove('active');
                        });
                        
                        // Mostrar la pesta√±a seleccionada
                        document.getElementById(tabName).classList.add('active');
                        
                        // Actualizar botones activos
                        document.querySelectorAll('.tab-button').forEach(function(button) {
                            button.classList.remove('active');
                        });
                        
                        // Activar el bot√≥n correspondiente
                        event.target.classList.add('active');
                    }
                    
                    // Validaci√≥n de formulario
                    function validateForm() {
                        var isValid = true;
                        
                        // Validar nombres
                        var nombres = document.getElementById('formCrearPersona:nombres').value;
                        if (!nombres || nombres.trim() === '') {
                            alert('Los nombres son requeridos');
                            isValid = false;
                        }
                        
                        // Validar apellidos
                        var apellidos = document.getElementById('formCrearPersona:apellidos').value;
                        if (!apellidos || apellidos.trim() === '') {
                            alert('Los apellidos son requeridos');
                            isValid = false;
                        }
                        
                        // Validar documento
                        var documento = document.getElementById('formCrearPersona:documento').value;
                        if (!documento || documento.trim() === '') {
                            alert('El documento es requerido');
                            isValid = false;
                        }
                        
                        // Validar email
                        var email = document.getElementById('formCrearPersona:email').value;
                        var emailPattern = /^[A-Za-z0-9+_.-]+@(.+)$/;
                        if (!email || email.trim() === '') {
                            alert('El email es requerido');
                            isValid = false;
                        } else if (!emailPattern.test(email)) {
                            alert('Formato de email inv√°lido');
                            isValid = false;
                        }
                        
                        // Validar tipo de persona
                        var peperTipo = document.getElementById('formCrearPersona:peperTipo_input').value;
                        if (!peperTipo || peperTipo.trim() === '' || peperTipo === 'Seleccione tipo') {
                            alert('Debe seleccionar un tipo de persona');
                            isValid = false;
                        }
                        
                        // Validar fecha de ingreso
                        var fechaIngreso = document.getElementById('formCrearPersona:fecha_ingreso_input').value;
                        if (!fechaIngreso || fechaIngreso.trim() === '') {
                            alert('La fecha de ingreso es requerida');
                            isValid = false;
                        }
                        
                        return isValid;
                    }
                </script>

                <!-- Ayuda -->
                <div class="form-help">
                    <p><strong>üìã Informaci√≥n importante:</strong></p>
                    <p>‚Ä¢ <span class="form-required">*</span> Campos obligatorios</p>
                    <p>‚Ä¢ El c√≥digo de persona se genera autom√°ticamente</p>
                    <p>‚Ä¢ <strong>Informaci√≥n B√°sica:</strong> Nombres, Apellidos, Documento, Fecha Nacimiento, Celular, Fecha Ingreso</p>
                    <p>‚Ä¢ <strong>Datos Personales:</strong> Tipo de Persona, Sexo, Estado Civil e Imagen</p>
                    <p>‚Ä¢ <strong>Contactos:</strong> Email (obligatorio)</p>
                    <p>‚Ä¢ La imagen de perfil es opcional y se almacenar√° en el servidor</p>
                    <p>‚Ä¢ Usuario y contrase√±a se generan autom√°ticamente y se env√≠an por correo</p>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="form-actions">
                    <p:commandButton value="üíæ Crear Persona" 
                                   action="#{crearPersonaController.crearPersona}"
                                   update="@form :messages"
                                   icon="pi pi-save"
                                   styleClass="ui-button-primary"
                                   style="margin-right: 10px; padding: 8px 20px;"
                                   onclick="return validateForm();"/>
                    
                    <p:commandButton value="üîÑ Limpiar" 
                                   action="#{crearPersonaController.initNuevaPersona}"
                                   update="@form :messages"
                                   immediate="true"
                                   icon="pi pi-refresh"
                                   styleClass="ui-button-secondary"
                                   style="margin-right: 10px; padding: 8px 20px;"/>
                    
                    <p:button value="‚Ü©Ô∏è Cancelar" 
                            icon="pi pi-times"
                            outcome="/index.xhtml"
                            style="padding: 8px 20px;"/>
                </div>
            </h:form>
            
            <!-- Growl para mensajes -->
            <p:growl id="messages" showDetail="true" />
        </div>
        
        <!-- Informaci√≥n de depuraci√≥n -->
        <div style="margin-top: 30px; padding: 15px; background-color: #f8f9fa; border-radius: 5px; max-width: 800px; margin: 30px auto;">
            <h3 style="color: #2a64c5;">üìä Informaci√≥n del Sistema</h3>
            <p><strong>Base de datos:</strong> monster_university_neatbeans</p>
            <p><strong>Colecci√≥n:</strong> personas</p>
            <p><strong>Servidor MongoDB:</strong> localhost:27017</p>
            <p><strong>Estado conexi√≥n:</strong> 
                <span style="color: green; font-weight: bold;">‚úì Activa</span>
            </p>
        </div>
    </ui:define>

    <ui:define name="footer">
        <div style="width: 100%; text-align: center; font-size: 0.9rem; color: #666;">
            ¬© #{java.time.LocalDate.now().year} Monster University - Sistema de Gesti√≥n Acad√©mica
        </div>
    </ui:define>
</ui:composition>