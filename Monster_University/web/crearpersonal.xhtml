<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:p="http://primefaces.org/ui"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                template="/template.xhtml">
    
    <ui:define name="title">Crear Nueva Persona</ui:define>

    <ui:define name="body">
        <div class="form-container" style="max-width: 800px; margin: 0 auto; padding: 20px; background-color: rgba(255, 255, 255, 0.95); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; z-index: 1;">
            
            <script>
                function debug(message) {
                    console.log("[DEBUG] " + message);
                }
                
                function debugError(message) {
                    console.error("[ERROR] " + message);
                }
                
                function debugSuccess(message) {
                    console.log("‚úÖ " + message);
                }
                
                console.log("=== FORMULARIO CREAR PERSONA CARGADO ===");
                
                document.addEventListener('DOMContentLoaded', function() {
                    console.log("üìù INSTRUCCIONES:");
                    console.log("1. Llena el formulario");
                    console.log("2. Los campos con * son obligatorios");
                    console.log("3. Estado Civil, Sexo y Celular son opcionales");
                    console.log("4. Haz click en 'Crear Persona'");
                });
            </script>
            
            <style>
                .form-header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 2px solid #2a64c5;
                    padding-bottom: 10px;
                }
                
                .form-header h1 {
                    color: #2a64c5;
                    font-size: 2rem;
                    margin-bottom: 5px;
                }
                
                .form-header p {
                    color: #666;
                    font-size: 1rem;
                }
                
                .form-group {
                    margin-bottom: 20px;
                    padding: 10px;
                    border-radius: 5px;
                    background-color: #f8f9fa;
                }
                
                .form-label {
                    display: block;
                    margin-bottom: 8px;
                    font-weight: bold;
                    color: #495057;
                    font-size: 0.9rem;
                }
                
                .form-required {
                    color: #dc3545;
                    margin-left: 3px;
                }
                
                .form-actions {
                    margin-top: 30px;
                    text-align: center;
                    padding-top: 20px;
                    border-top: 1px solid #dee2e6;
                }
                
                .form-help {
                    margin-top: 15px;
                    padding: 10px;
                    background-color: #e7f3ff;
                    border-left: 4px solid #2a64c5;
                    font-size: 0.9rem;
                    color: #666;
                }
                
                .form-row {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .form-column {
                    flex: 1;
                }
                
                .field-hint {
                    font-size: 0.8rem;
                    color: #666;
                    margin-top: 5px;
                    font-style: italic;
                }
                
                .radio-group {
                    display: flex;
                    gap: 20px;
                    margin-top: 5px;
                    flex-wrap: wrap;
                }
                
                .radio-option {
                    display: flex;
                    align-items: center;
                    gap: 5px;
                }
                
                .radio-label {
                    font-weight: normal;
                    color: #495057;
                    font-size: 0.9rem;
                }
                
                .tab-container {
                    margin-top: 20px;
                    border: 1px solid #dee2e6;
                    border-radius: 5px;
                    overflow: hidden;
                }
                
                .tab-buttons {
                    display: flex;
                    background-color: #f8f9fa;
                    border-bottom: 1px solid #dee2e6;
                }
                
                .tab-button {
                    padding: 12px 20px;
                    background: none;
                    border: none;
                    cursor: pointer;
                    font-size: 0.95rem;
                    font-weight: 500;
                    color: #495057;
                    transition: all 0.3s;
                    border-bottom: 3px solid transparent;
                }
                
                .tab-button:hover {
                    background-color: #e9ecef;
                }
                
                .tab-button.active {
                    color: #2a64c5;
                    border-bottom: 3px solid #2a64c5;
                    background-color: #e7f3ff;
                }
                
                .tab-content {
                    padding: 20px;
                    background-color: white;
                }
                
                .tab-pane {
                    display: none;
                }
                
                .tab-pane.active {
                    display: block;
                }
                
                .basic-info-section {
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 5px;
                    margin-bottom: 20px;
                }
                
                .basic-info-row {
                    display: flex;
                    gap: 15px;
                    margin-bottom: 15px;
                }
                
                .basic-info-column {
                    flex: 1;
                }
            </style>
            
            <div class="form-header">
                <h1>üë§ Crear Nueva Persona</h1>
                <p>Complete los datos para registrar una nueva persona en el sistema</p>
            </div>
            
            <h:form id="formCrearPersona" enctype="multipart/form-data">
                
                <!-- Secci√≥n de informaci√≥n b√°sica -->
                <div class="basic-info-section">
                    <h3 style="color: #2a64c5; margin-bottom: 20px; border-bottom: 1px solid #dee2e6; padding-bottom: 10px;">
                        üìù Informaci√≥n B√°sica
                    </h3>
                    
                    <div class="basic-info-row">
                        <!-- ID Persona -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="peperId" value="ID Persona" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:inputText id="peperId" value="#{crearPersonaController.idGenerado}" 
                                           style="width: 100%; background-color: #e9ecef;"
                                           readonly="true"
                                           placeholder="Se genera autom√°ticamente"/>
                                <div class="field-hint">(Generado autom√°ticamente)</div>
                                <!-- Campo oculto para mantener el valor -->
                                <h:inputHidden value="#{crearPersonaController.nuevaPersona.peperId}"/>
                            </div>
                        </div>
                        
                        <!-- Fecha de Ingreso -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="pepeperFechIngr" value="Fecha de Ingreso" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:calendar id="pepeperFechIngr" value="#{crearPersonaController.nuevaPersona.pepeperFechIngr}" 
                                            style="width: 100%;"
                                            pattern="dd/MM/yyyy" 
                                            locale="es" 
                                            showOn="button"
                                            placeholder="Seleccione fecha"
                                            required="true"
                                            requiredMessage="La fecha de ingreso es requerida">
                                    <f:convertDateTime pattern="dd/MM/yyyy" />
                                </p:calendar>
                                <p:message for="pepeperFechIngr" display="icon"/>
                            </div>
                        </div>
                    </div>

                    <div class="basic-info-row">
                        <!-- Nombre -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="peperNombre" value="Nombre" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:inputText id="peperNombre" value="#{crearPersonaController.nuevaPersona.peperNombre}" 
                                           maxlength="25" style="width: 100%;"
                                           placeholder="Ingrese el nombre"
                                           required="true"
                                           requiredMessage="El nombre es requerido"/>
                                <div class="field-hint">(M√°ximo 25 caracteres)</div>
                                <p:message for="peperNombre" display="icon"/>
                            </div>
                        </div>
                        
                        <!-- Apellido -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="peperApellido" value="Apellido" styleClass="form-label"/>
                                <span class="form-required">*</span>
                                <p:inputText id="peperApellido" value="#{crearPersonaController.nuevaPersona.peperApellido}" 
                                           maxlength="25" style="width: 100%;"
                                           placeholder="Ingrese el apellido"
                                           required="true"
                                           requiredMessage="El apellido es requerido"/>
                                <div class="field-hint">(M√°ximo 25 caracteres)</div>
                                <p:message for="peperApellido" display="icon"/>
                            </div>
                        </div>
                    </div>

                    <div class="basic-info-row">
                        <!-- Fecha de Nacimiento -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="pepeperFecNa" value="Fecha de Nacimiento" styleClass="form-label"/>
                                <p:calendar id="pepeperFecNa" value="#{crearPersonaController.nuevaPersona.pepeperFecNa}" 
                                            style="width: 100%;"
                                            pattern="dd/MM/yyyy" 
                                            locale="es" 
                                            showOn="button"
                                            placeholder="Seleccione fecha"
                                            yearRange="c-100:c"
                                            required="false">
                                    <f:convertDateTime pattern="dd/MM/yyyy" />
                                </p:calendar>
                                <div class="field-hint">(Opcional)</div>
                                <p:message for="pepeperFecNa" display="icon"/>
                            </div>
                        </div>
                        
                      
                    </div>
                </div>
                
                <!-- Secci√≥n de pesta√±as -->
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button type="button" class="tab-button active" onclick="showTab('datosPersonales')">
                            üìã Datos Personales
                        </button>
                        <button type="button" class="tab-button" onclick="showTab('contactos')">
                            üìß Contactos
                        </button>
                    </div>
                    
                    <!-- Pesta√±a Datos Personales -->
                    <div class="tab-content">
                        <div id="datosPersonales" class="tab-pane active">
                            <div style="padding: 15px;">
                                <!-- Tipo de Persona -->
                                <div class="form-group">
                                    <h:outputLabel for="peperTipo" value="Tipo de Persona" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:selectOneMenu id="peperTipo" value="#{crearPersonaController.nuevaPersona.peperTipo}" 
                                                   style="width: 100%;"
                                                   required="true"
                                                   requiredMessage="Debe seleccionar un tipo">
                                        <f:selectItem itemLabel="Seleccione tipo" itemValue=""/>
                                        <f:selectItem itemLabel="Administrador del Sistema" itemValue="Administrador del Sistema"/>
                                        <f:selectItem itemLabel="Docente" itemValue="Docente"/>
                                        <f:selectItem itemLabel="Administrador de matr√≠culas" itemValue="Administrador de matriculas"/>
                                        <f:selectItem itemLabel="Secretar√≠a Acad√©mica" itemValue="Secretaria Academica"/>
                                    </p:selectOneMenu>
                                    <p:message for="peperTipo" display="icon"/>
                                </div>
                                
                                <!-- C√©dula -->
                                <div class="form-group">
                                    <h:outputLabel for="peperCedula" value="C√©dula" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:inputText id="peperCedula" value="#{crearPersonaController.nuevaPersona.peperCedula}" 
                                               maxlength="15" style="width: 100%;"
                                               placeholder="Ej: 1234567890"
                                               required="true"
                                               requiredMessage="La c√©dula es requerida"/>
                                    <div class="field-hint">(M√°ximo 15 caracteres)</div>
                                    <p:message for="peperCedula" display="icon"/>
                                </div>

                                <!-- Sexo -->
                                <div class="form-group">
                                    <h:outputLabel for="codigoSexoSeleccionado" value="Sexo" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:selectOneRadio id="codigoSexoSeleccionado" 
                                                    value="#{crearPersonaController.codigoSexoSeleccionado}"
                                                    layout="custom"
                                                    required="true"
                                                    requiredMessage="Debe seleccionar el sexo">
                                        <f:selectItem itemLabel="Masculino" itemValue="M"/>
                                        <f:selectItem itemLabel="Femenino" itemValue="F"/>
                                    </p:selectOneRadio>
                                    <div class="radio-group">
                                        <div class="radio-option">
                                            <p:radioButton id="sexoM" for="codigoSexoSeleccionado" itemIndex="0"/>
                                            <h:outputLabel for="sexoM" value="Masculino" styleClass="radio-label"/>
                                        </div>
                                        <div class="radio-option">
                                            <p:radioButton id="sexoF" for="codigoSexoSeleccionado" itemIndex="1"/>
                                            <h:outputLabel for="sexoF" value="Femenino" styleClass="radio-label"/>
                                        </div>
                                    </div>
                                    <p:message for="codigoSexoSeleccionado" display="icon"/>
                                </div>
                                
                                <!-- Estado Civil -->
                                <div class="form-group">
                                    <h:outputLabel for="codigoEstcivSeleccionado" value="Estado Civil" styleClass="form-label"/>
                                    <p:selectOneMenu id="codigoEstcivSeleccionado" 
                                                   value="#{crearPersonaController.codigoEstcivSeleccionado}"
                                                   style="width: 100%;">
                                        <f:selectItem itemLabel="Seleccione estado civil" itemValue=""/>
                                        <f:selectItems value="#{crearPersonaController.estadosCiviles}" 
                                                     var="estciv"
                                                     itemLabel="#{estciv.peescDescri}"
                                                     itemValue="#{estciv.peescId}"/>
                                    </p:selectOneMenu>
                                    <div class="field-hint">(Opcional)</div>
                                    <p:message for="codigoEstcivSeleccionado" display="icon"/>
                                </div>
                                
                               <!-- Imagen de perfil -->
                                    <!-- Imagen de perfil - VERSI√ìN FINAL SIMPLIFICADA -->
                                    <!-- Imagen de perfil - Versi√≥n corregida -->
<div class="form-group">
    <h:outputLabel for="imagenPersona" value="Imagen de Perfil" styleClass="form-label"/>
    
    <!-- FileUpload SIMPLE sin auto-upload -->
    <p:fileUpload id="imagenPersona" 
                  value="#{crearPersonaController.imagenSubida}"
                  mode="simple"
                  skinSimple="true"
                  sizeLimit="1048576"
                  allowTypes="/(\.|\/)(gif|jpe?g|png)$/"
                  style="width: 100%; margin-bottom: 10px;"
                  required="false"/>
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <!-- Bot√≥n Subir Imagen - AJAX simple -->
        <p:commandButton value="Subir Imagen"
                         action="#{crearPersonaController.subirImagen}"
                         ajax="true"
                         process="@form"
                         update=":formCrearPersona:vistaPreviaImagen 
                                 :formCrearPersona:mensajeImagen
                                 :formCrearPersona:infoImagen"
                         oncomplete="if(args &amp;&amp; !args.validationFailed) {PF('imagenWidget').clear();}"
                         icon="pi pi-upload"
                         styleClass="ui-button-success"/>
        
        <!-- Bot√≥n Eliminar Imagen -->
        <p:commandButton value="Eliminar Imagen"
                         action="#{crearPersonaController.eliminarImagen}"
                         ajax="true"
                         process="@this"
                         update=":formCrearPersona:vistaPreviaImagen 
                                 :formCrearPersona:mensajeImagen
                                 :formCrearPersona:infoImagen"
                         icon="pi pi-trash"
                         styleClass="ui-button-danger"
                         rendered="#{not empty crearPersonaController.nuevaPersona.pepeperImag}"/>
    </div>
    
    <div class="field-hint">(Opcional, m√°ximo 1MB, formatos: JPG, PNG, GIF)</div>
    <p:message for="imagenPersona" id="mensajeImagen" />
    
    <!-- Informaci√≥n de la imagen subida -->
    <h:panelGroup id="infoImagen">
        <div style="margin-top: 10px; padding: 8px; background-color: #f8f9fa; border-radius: 4px; font-size: 0.9rem;">
            <h:outputText value="üìÅ Archivo: #{crearPersonaController.nuevaPersona.pepeperImag}"
                          rendered="#{not empty crearPersonaController.nuevaPersona.pepeperImag}"
                          style="font-weight: bold;"/>
        </div>
    </h:panelGroup>
    
    <!-- Vista previa de imagen -->
    <h:panelGroup id="vistaPreviaImagen">
       <!-- Vista previa de imagen -->
<div style="margin-top: 15px; text-align: center;">
    <p:graphicImage value="#{crearPersonaController.urlImagen}"
                    rendered="#{not empty crearPersonaController.nuevaPersona.pepeperImag}"
                    cache="false"
                    width="150"
                    height="150"
                    style="border-radius: 8px; border: 2px solid #ddd;
                           object-fit: cover; max-width: 150px; max-height: 150px;
                           box-shadow: 0 2px 5px rgba(0,0,0,0.1);"/>
</div>
    </h:panelGroup>
</div>
                            </div>
                        </div>
                        
                        <!-- Pesta√±a Contactos -->
                        <div id="contactos" class="tab-pane">
                            <div style="padding: 15px;">
                                <!-- Email -->
                                <div class="form-group">
                                    <h:outputLabel for="peperEmail" value="Email" styleClass="form-label"/>
                                    <span class="form-required">*</span>
                                    <p:inputText id="peperEmail" value="#{crearPersonaController.nuevaPersona.peperEmail}" 
                                                 maxlength="30" style="width: 100%;"
                                                 placeholder="ejemplo@correo.com"
                                                 required="true"
                                                 requiredMessage="El email es requerido">
                                        <f:validateRegex pattern="^[A-Za-z0-9+_.-]+@(.+)$" />
                                    </p:inputText>
                                    <div class="field-hint">(M√°ximo 30 caracteres)</div>
                                    <p:message for="peperEmail" display="icon"/>
                                </div>
                                
                                  <!-- Celular  -->
                        <div class="basic-info-column">
                            <div class="form-group">
                                <h:outputLabel for="peperCelular" value="Celular" styleClass="form-label"/>
                                <p:inputText id="peperCelular" value="#{crearPersonaController.nuevaPersona.peperCelular}" 
                                           maxlength="15" style="width: 100%;"
                                           placeholder="Ej: 0991234567 (opcional)"/>
                                <div class="field-hint">(Opcional, formato: 09XXXXXXXX)</div>
                                <p:message for="peperCelular" display="icon"/>
                            </div>
                        </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Script para manejar las pesta√±as -->
                <script>
                    function showTab(tabName) {
                        // Ocultar todas las pesta√±as
                        document.querySelectorAll('.tab-pane').forEach(function(tab) {
                            tab.classList.remove('active');
                        });
                        
                        // Mostrar la pesta√±a seleccionada
                        document.getElementById(tabName).classList.add('active');
                        
                        // Actualizar botones activos
                        document.querySelectorAll('.tab-button').forEach(function(button) {
                            button.classList.remove('active');
                        });
                        
                        // Activar el bot√≥n correspondiente
                        event.target.classList.add('active');
                    }
                    
                    // Validaci√≥n de formulario
                    function validateForm() {
                        var isValid = true;
                        
                        // Validar nombre
                        var nombre = document.getElementById('formCrearPersona:peperNombre').value;
                        if (!nombre || nombre.trim() === '') {
                            alert('El nombre es requerido');
                            isValid = false;
                        }
                        
                        // Validar apellido
                        var apellido = document.getElementById('formCrearPersona:peperApellido').value;
                        if (!apellido || apellido.trim() === '') {
                            alert('El apellido es requerido');
                            isValid = false;
                        }
                        
                        // Validar c√©dula
                        var cedula = document.getElementById('formCrearPersona:peperCedula').value;
                        if (!cedula || cedula.trim() === '') {
                            alert('La c√©dula es requerida');
                            isValid = false;
                        }
                        
                        // Validar email
                        var email = document.getElementById('formCrearPersona:peperEmail').value;
                        var emailPattern = /^[A-Za-z0-9+_.-]+@(.+)$/;
                        if (!email || email.trim() === '') {
                            alert('El email es requerido');
                            isValid = false;
                        } else if (!emailPattern.test(email)) {
                            alert('Formato de email inv√°lido');
                            isValid = false;
                        }
                        
                        // Validar tipo de persona
                      
                        
                        // Validar fecha de ingreso
                        var fechaIngreso = document.getElementById('formCrearPersona:pepeperFechIngr_input').value;
                        if (!fechaIngreso || fechaIngreso.trim() === '') {
                            alert('La fecha de ingreso es requerida');
                            isValid = false;
                        }
                        
                        return isValid;
                    }
                </script>

                <!-- Ayuda -->
                <div class="form-help">
                    <p><strong>üìã Informaci√≥n importante:</strong></p>
                    <p>‚Ä¢ <span class="form-required">*</span> Campos obligatorios</p>
                    <p>‚Ä¢ El ID de persona se genera autom√°ticamente</p>
                    <p>‚Ä¢ <strong>Datos Personales:</strong> Tipo, C√©dula, Sexo, Estado Civil e Imagen</p>
                    <p>‚Ä¢ <strong>Contactos:</strong> Email (el celular est√° en Informaci√≥n B√°sica)</p>
                    <p>‚Ä¢ La imagen de perfil es opcional y se almacenar√° en formato Base64</p>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="form-actions">
                    <p:commandButton value="üíæ Crear Persona" 
                                   action="#{crearPersonaController.crearPersona}"
                                   update="@form :growl"
                                   icon="pi pi-save"
                                   styleClass="ui-button-primary"
                                   style="margin-right: 10px; padding: 8px 20px;"
                                   onclick="return validateForm();"/>
                    
                    <p:commandButton value="üîÑ Limpiar" 
                                   action="#{crearPersonaController.initNuevaPersona}"
                                   update="@form :growl"
                                   immediate="true"
                                   icon="pi pi-refresh"
                                   styleClass="ui-button-secondary"
                                   style="margin-right: 10px; padding: 8px 20px;"/>
                    
                    <p:button value="‚Ü©Ô∏è Cancelar" 
                            icon="pi pi-times"
                            outcome="/index.xhtml"
                            style="padding: 8px 20px;"/>
                </div>
            </h:form>
        </div>
    </ui:define>

    <ui:define name="footer">
        <div style="width: 100%; text-align: center; font-size: 0.9rem; color: #666;">
            ¬© #{java.time.LocalDate.now().year} Monster University - Sistema de Gesti√≥n Acad√©mica
        </div>
    </ui:define>
</ui:composition>